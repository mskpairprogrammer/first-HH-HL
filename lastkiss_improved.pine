//@version=6
strategy("Last Kiss - Zone & CVD Strategy", overlay=true, initial_capital=100000, default_qty_type=strategy.percent_of_equity, default_qty_value=5)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grpZones = "Zone Detection"
zoneLookback    = input.int(50, "Zone Lookback Bars", minval=10, maxval=200, group=grpZones)
zoneThreshold   = input.float(1.5, "Volume Threshold for Zone", minval=1.0, step=0.1, group=grpZones)
zoneWidth       = input.float(0.5, "Zone Width %", minval=0.1, maxval=2.0, step=0.1, group=grpZones, tooltip="Width of S/R zone as % of price")
maxZones        = input.int(3, "Max Zones to Track", minval=1, maxval=5, group=grpZones)

grpCVD = "CVD Settings"
cvdLength       = input.int(14, "CVD MA Length", minval=5, maxval=50, group=grpCVD)
divLookback     = input.int(10, "Divergence Lookback", minval=3, maxval=20, group=grpCVD)
showCVDPanel    = input.bool(true, "Show CVD Panel", group=grpCVD)

grpRisk = "Risk Management"
riskPerTrade    = input.float(15.0, "Stop Loss %", group=grpRisk)
target1Pct      = input.float(5.0, "Target 1 %", group=grpRisk)
target2Pct      = input.float(10.0, "Target 2 %", group=grpRisk)
target3Pct      = input.float(20.0, "Target 3 %", group=grpRisk)

grpVisual = "Visuals"
resistanceColor = input.color(color.new(color.gray, 70), "Resistance Zone", group=grpVisual)
supportColor    = input.color(color.new(color.gray, 70), "Support Zone", group=grpVisual)
keyLevelColor   = input.color(color.yellow, "Key Level Line", group=grpVisual)
cvdBullColor    = input.color(color.aqua, "CVD Bullish", group=grpVisual)
cvdBearColor    = input.color(color.orange, "CVD Bearish/Divergence", group=grpVisual)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CVD (CUMULATIVE VOLUME DELTA) CALCULATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// More accurate CVD using candle position
deltaVolume = volume * ((close - open) / (high - low == 0 ? 1 : high - low))
var float cvd = 0.0
cvd := cvd + deltaVolume
cvdMA = ta.sma(cvd, cvdLength)
cvdRising = ta.rising(cvd, divLookback)
cvdFalling = ta.falling(cvd, divLookback)

// Divergence Detection
priceRising = ta.rising(close, divLookback)
priceFalling = ta.falling(close, divLookback)
bullishDivergence = priceFalling and cvdRising  // Price down, CVD up = accumulation
bearishDivergence = priceRising and cvdFalling   // Price up, CVD down = distribution

// CVD Momentum
cvdMomentum = cvd - cvdMA
cvdBullish = cvdMomentum > 0

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VOLUME ANALYSIS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
avgVol = ta.sma(volume, 20)
isHighVol = volume > (avgVol * zoneThreshold)
isBullishCandle = close > open
isBearishCandle = close < open

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DYNAMIC ZONE DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Track up to 3 resistance and 3 support zones
var float[] resistanceZones = array.new_float(maxZones, na)
var float[] resistanceZonesLow = array.new_float(maxZones, na)
var int[] resistanceBars = array.new_int(maxZones, na)

var float[] supportZones = array.new_float(maxZones, na)
var float[] supportZonesHigh = array.new_float(maxZones, na)
var int[] supportBars = array.new_int(maxZones, na)

// Zone width calculation
zoneWidthValue = close * (zoneWidth / 100)

// Create new resistance zone on high-volume bearish candle
if isHighVol and isBearishCandle
    // Shift existing zones
    for i = maxZones - 1 to 1
        array.set(resistanceZones, i, array.get(resistanceZones, i - 1))
        array.set(resistanceZonesLow, i, array.get(resistanceZonesLow, i - 1))
        array.set(resistanceBars, i, array.get(resistanceBars, i - 1))
    // Add new zone
    array.set(resistanceZones, 0, high)
    array.set(resistanceZonesLow, 0, high - zoneWidthValue)
    array.set(resistanceBars, 0, bar_index)

// Create new support zone on high-volume bullish candle
if isHighVol and isBullishCandle
    // Shift existing zones
    for i = maxZones - 1 to 1
        array.set(supportZones, i, array.get(supportZones, i - 1))
        array.set(supportZonesHigh, i, array.get(supportZonesHigh, i - 1))
        array.set(supportBars, i, array.get(supportBars, i - 1))
    // Add new zone
    array.set(supportZones, 0, low)
    array.set(supportZonesHigh, 0, low + zoneWidthValue)
    array.set(supportBars, 0, bar_index)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ZONE VISUALIZATION (BOXES)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var box[] resistanceBoxes = array.new_box(maxZones)
var box[] supportBoxes = array.new_box(maxZones)
var line[] keyResistanceLines = array.new_line(maxZones)
var line[] keySupportLines = array.new_line(maxZones)

// Initialize boxes once
if barstate.isfirst
    for i = 0 to maxZones - 1
        array.set(resistanceBoxes, i, box.new(na, na, na, na, bgcolor=resistanceColor, border_color=color.new(color.white, 80)))
        array.set(supportBoxes, i, box.new(na, na, na, na, bgcolor=supportColor, border_color=color.new(color.white, 80)))
        array.set(keyResistanceLines, i, line.new(na, na, na, na, color=keyLevelColor, width=1))
        array.set(keySupportLines, i, line.new(na, na, na, na, color=keyLevelColor, width=1))

// Update boxes on each bar
if barstate.islast
    for i = 0 to maxZones - 1
        resTop = array.get(resistanceZones, i)
        resBot = array.get(resistanceZonesLow, i)
        resBar = array.get(resistanceBars, i)
        
        if not na(resTop)
            box.set_lefttop(array.get(resistanceBoxes, i), resBar, resTop)
            box.set_rightbottom(array.get(resistanceBoxes, i), bar_index + 20, resBot)
            line.set_xy1(array.get(keyResistanceLines, i), resBar, resBot)
            line.set_xy2(array.get(keyResistanceLines, i), bar_index + 20, resBot)
        
        supBot = array.get(supportZones, i)
        supTop = array.get(supportZonesHigh, i)
        supBar = array.get(supportBars, i)
        
        if not na(supBot)
            box.set_lefttop(array.get(supportBoxes, i), supBar, supTop)
            box.set_rightbottom(array.get(supportBoxes, i), bar_index + 20, supBot)
            line.set_xy1(array.get(keySupportLines, i), supBar, supTop)
            line.set_xy2(array.get(keySupportLines, i), bar_index + 20, supTop)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LAST KISS ENTRY LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Check if price is testing a zone
var bool inResistanceZone = false
var bool inSupportZone = false
var float activeResistance = na
var float activeSupport = na

// Check resistance zones
for i = 0 to maxZones - 1
    resTop = array.get(resistanceZones, i)
    resBot = array.get(resistanceZonesLow, i)
    if not na(resTop) and high >= resBot and low <= resTop
        inResistanceZone := true
        activeResistance := resBot

// Check support zones  
for i = 0 to maxZones - 1
    supBot = array.get(supportZones, i)
    supTop = array.get(supportZonesHigh, i)
    if not na(supBot) and low <= supTop and high >= supBot
        inSupportZone := true
        activeSupport := supTop

// Breakout Detection
var bool breakoutUp = false
var bool breakoutDown = false
var float breakoutLevel = na

// Breakout above resistance
if not na(activeResistance) and close > array.get(resistanceZones, 0) and isHighVol
    breakoutUp := true
    breakoutLevel := array.get(resistanceZonesLow, 0)

// "Last Kiss" - Price retests broken level
lastKissLong = breakoutUp and low <= breakoutLevel * 1.005 and close > breakoutLevel and cvdBullish
lastKissShort = breakoutDown and high >= breakoutLevel * 0.995 and close < breakoutLevel and not cvdBullish

// Support bounce with CVD confirmation (accumulation pattern from your chart)
supportBounce = inSupportZone and bullishDivergence and close > open

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STRATEGY EXECUTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Entry conditions
longCondition = (lastKissLong or supportBounce) and not bearishDivergence

if longCondition and strategy.position_size == 0
    strategy.entry("LastKiss", strategy.long, comment="ðŸ”µ Kiss Entry")
    breakoutUp := false

// Stop loss below support zone
stopLevel = strategy.position_avg_price * (1 - riskPerTrade/100)

// Exit on bearish divergence or support break
if strategy.position_size > 0
    // Exit if price breaks below active support with volume
    if not na(activeSupport) and close < activeSupport and isHighVol
        strategy.close("LastKiss", comment="âŒ Support Lost")

// Tiered exits
strategy.exit("TP1", "LastKiss", qty_percent=33, limit=strategy.position_avg_price * (1 + target1Pct/100), stop=stopLevel, comment_profit="âœ“ TP1")
strategy.exit("TP2", "LastKiss", qty_percent=33, limit=strategy.position_avg_price * (1 + target2Pct/100), stop=strategy.position_avg_price, comment_profit="âœ“ TP2")
strategy.exit("TP3", "LastKiss", limit=strategy.position_avg_price * (1 + target3Pct/100), trail_points=close * 0.03, trail_offset=close * 0.01, comment_profit="âœ“ TP3")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CVD PANEL (SEPARATE PANE)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Plot CVD in separate pane (will auto-create when indicator is added)
plot(showCVDPanel ? cvd : na, "CVD", color=cvdBullish ? cvdBullColor : color.white, linewidth=2, display=display.pane)
plot(showCVDPanel ? cvdMA : na, "CVD MA", color=color.new(color.orange, 30), linewidth=1, style=plot.style_line, display=display.pane)
hline(0, "Zero Line", color=color.new(color.yellow, 50), linestyle=hline.style_dashed)

// Highlight divergence areas on CVD (like the orange ellipses in your chart)
bgcolor(showCVDPanel and bullishDivergence ? color.new(cvdBearColor, 80) : na, title="Bullish Divergence Zone")
bgcolor(showCVDPanel and bearishDivergence ? color.new(color.red, 80) : na, title="Bearish Divergence Zone")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN CHART VISUALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Entry signals
plotshape(lastKissLong, "Last Kiss Long", shape.triangleup, location.belowbar, cvdBullColor, size=size.normal, text="KISS")
plotshape(supportBounce and not lastKissLong, "Support Bounce", shape.triangleup, location.belowbar, color.lime, size=size.small, text="ACC")

// Divergence warnings
plotshape(bearishDivergence, "Bearish Divergence", shape.xcross, location.abovebar, cvdBearColor, size=size.small, text="DIV")
plotshape(bullishDivergence and inSupportZone, "Accumulation", shape.diamond, location.belowbar, color.new(cvdBearColor, 0), size=size.small)

// High volume candles
plotshape(isHighVol and isBullishCandle, "High Vol Bull", shape.circle, location.belowbar, color.new(color.green, 50), size=size.tiny)
plotshape(isHighVol and isBearishCandle, "High Vol Bear", shape.circle, location.abovebar, color.new(color.red, 50), size=size.tiny)

// Background on divergence (matching your chart's highlighted areas)
bgcolor(bullishDivergence and inSupportZone ? color.new(cvdBearColor, 90) : na, title="Accumulation Zone Highlight")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INFO TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var table infoTable = table.new(position.top_right, 2, 6, bgcolor=color.new(color.black, 80), border_width=1)

if barstate.islast
    table.cell(infoTable, 0, 0, "CVD Status", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, cvdBullish ? "BULLISH" : "BEARISH", text_color=cvdBullish ? color.lime : color.red, text_size=size.small)
    
    table.cell(infoTable, 0, 1, "Divergence", text_color=color.white, text_size=size.small)
    divText = bullishDivergence ? "BULL DIV" : bearishDivergence ? "BEAR DIV" : "NONE"
    divColor = bullishDivergence ? color.lime : bearishDivergence ? color.orange : color.gray
    table.cell(infoTable, 1, 1, divText, text_color=divColor, text_size=size.small)
    
    table.cell(infoTable, 0, 2, "Zone", text_color=color.white, text_size=size.small)
    zoneText = inResistanceZone ? "RESISTANCE" : inSupportZone ? "SUPPORT" : "NEUTRAL"
    zoneColor = inResistanceZone ? color.red : inSupportZone ? color.green : color.gray
    table.cell(infoTable, 1, 2, zoneText, text_color=zoneColor, text_size=size.small)
    
    table.cell(infoTable, 0, 3, "Resistance", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 3, str.tostring(array.get(resistanceZones, 0), format.mintick), text_color=color.red, text_size=size.small)
    
    table.cell(infoTable, 0, 4, "Support", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 4, str.tostring(array.get(supportZones, 0), format.mintick), text_color=color.green, text_size=size.small)
    
    table.cell(infoTable, 0, 5, "Signal", text_color=color.white, text_size=size.small)
    sigText = lastKissLong ? "LAST KISS" : supportBounce ? "ACCUMULATION" : "WAITING"
    sigColor = lastKissLong or supportBounce ? color.aqua : color.yellow
    table.cell(infoTable, 1, 5, sigText, text_color=sigColor, text_size=size.small)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
alertcondition(lastKissLong, "Last Kiss Entry", "Last Kiss pattern detected - potential long entry!")
alertcondition(supportBounce, "Support Accumulation", "CVD accumulation at support zone!")
alertcondition(bearishDivergence, "Bearish Divergence", "Warning: Price rising but CVD falling - distribution!")
